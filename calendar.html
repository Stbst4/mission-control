<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar ‚Äî Mission Control</title>
  <style>
    :root {
      --bg: #0A0A0A;
      --card: rgba(255,255,255,0.03);
      --card-hover: rgba(255,255,255,0.05);
      --border: rgba(255,255,255,0.06);
      --border-hover: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.9);
      --text-secondary: rgba(255,255,255,0.5);
      --text-muted: rgba(255,255,255,0.3);
      --red: #ef4444;
      --red-glow: rgba(239,68,68,0.15);
      --emerald: #34d399;
      --amber: #fbbf24;
      --blue: #60a5fa;
      --violet: #a78bfa;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }
    body::before, body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      filter: blur(120px);
      pointer-events: none;
      z-index: 0;
    }
    body::before {
      width: 600px; height: 600px;
      background: var(--red-glow);
      top: -200px; right: -200px;
    }
    body::after {
      width: 400px; height: 400px;
      background: rgba(239,68,68,0.08);
      bottom: -100px; left: -100px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px;
      position: relative;
      z-index: 1;
    }

    /* Nav */
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
    }
    .nav-left { display: flex; align-items: center; gap: 16px; }
    .logo { font-size: 28px; text-decoration: none; }
    .nav h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.02em; }
    .nav h1 span { color: var(--red); }
    .nav-links { display: flex; gap: 4px; }
    .nav-link {
      padding: 8px 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 100px;
      color: var(--text-secondary);
      font-size: 13px;
      text-decoration: none;
      transition: all 0.2s;
      font-family: inherit;
    }
    .nav-link:hover { border-color: var(--border-hover); color: var(--text); }
    .nav-link.active {
      background: rgba(239,68,68,0.1);
      border-color: rgba(239,68,68,0.3);
      color: var(--red);
    }

    /* Month header */
    .month-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .month-title { font-size: 22px; font-weight: 700; letter-spacing: -0.01em; }
    .month-nav { display: flex; gap: 8px; }
    .month-btn {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .month-btn:hover { border-color: var(--border-hover); color: var(--text); }

    /* Calendar grid */
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 40px;
    }
    .cal-dow {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 8px 0;
    }
    .cal-day {
      min-height: 100px;
      background: linear-gradient(135deg, var(--card), transparent);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      transition: all 0.2s;
      cursor: default;
      overflow: hidden;
    }
    .cal-day:hover { border-color: var(--border-hover); }
    .cal-day.today { border-color: rgba(239,68,68,0.3); background: rgba(239,68,68,0.03); }
    .cal-day.other-month { opacity: 0.3; }
    .cal-day-num {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .cal-day.today .cal-day-num { color: var(--red); }

    .cal-event {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 6px;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: all 0.15s;
    }
    .cal-event:hover { filter: brightness(1.3); }
    .cal-event.recurring {
      background: rgba(139,92,246,0.12);
      color: var(--violet);
      border-left: 2px solid var(--violet);
    }
    .cal-event.one-shot {
      background: rgba(251,191,36,0.12);
      color: var(--amber);
      border-left: 2px solid var(--amber);
    }
    .cal-event.assignee-shane {
      background: rgba(251,191,36,0.12);
      color: var(--amber);
      border-left: 2px solid var(--amber);
    }
    .cal-event.assignee-clawd.recurring {
      background: rgba(139,92,246,0.12);
      color: var(--violet);
      border-left: 2px solid var(--violet);
    }

    .cal-more {
      font-size: 10px;
      color: var(--text-muted);
      padding: 2px 6px;
      cursor: pointer;
    }
    .cal-more:hover { color: var(--text-secondary); }

    /* Recurring sidebar */
    .section-title {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .recurring-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 40px; }
    .recurring-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      background: linear-gradient(135deg, var(--card), transparent);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s;
    }
    .recurring-card:hover { border-color: rgba(139,92,246,0.2); transform: translateY(-1px); }
    .recurring-time {
      font-size: 13px;
      font-weight: 600;
      color: var(--violet);
      min-width: 100px;
      white-space: nowrap;
    }
    .recurring-info { flex: 1; min-width: 0; }
    .recurring-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .recurring-desc {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .recurring-status {
      padding: 4px 10px;
      border-radius: 100px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .recurring-status.enabled {
      background: rgba(52,211,153,0.1);
      color: var(--emerald);
      border: 1px solid rgba(52,211,153,0.2);
    }
    .recurring-status.disabled {
      background: rgba(255,255,255,0.05);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    /* Upcoming list */
    .upcoming-list { display: flex; flex-direction: column; gap: 8px; }
    .upcoming-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 18px;
      background: linear-gradient(135deg, var(--card), transparent);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s;
    }
    .upcoming-card:hover { border-color: rgba(251,191,36,0.2); transform: translateY(-1px); }
    .upcoming-date {
      font-size: 13px;
      font-weight: 600;
      color: var(--amber);
      min-width: 120px;
      white-space: nowrap;
    }
    .upcoming-info { flex: 1; min-width: 0; }
    .upcoming-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
    .upcoming-desc {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .assignee-pill {
      padding: 4px 10px;
      border-radius: 100px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .assignee-shane { background: rgba(251,191,36,0.1); color: var(--amber); border: 1px solid rgba(251,191,36,0.2); }
    .assignee-clawd { background: rgba(239,68,68,0.1); color: var(--red); border: 1px solid rgba(239,68,68,0.2); }

    .updated-label {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
      margin-top: 32px;
    }

    /* Tooltip / modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #111;
      border: 1px solid var(--border-hover);
      border-radius: 16px;
      padding: 28px;
      max-width: 480px;
      width: 90%;
      position: relative;
    }
    .modal::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--red), var(--violet));
      border-radius: 16px 16px 0 0;
    }
    .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .modal-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 16px; }
    .modal-meta { font-size: 12px; color: var(--text-muted); line-height: 1.8; }
    .modal-meta strong { color: var(--text-secondary); }
    .modal-close {
      position: absolute;
      top: 16px; right: 16px;
      background: none; border: none;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .cal-grid { gap: 2px; }
      .cal-day { min-height: 60px; padding: 4px; }
      .cal-day-num { font-size: 11px; }
      .cal-event { font-size: 8px; padding: 2px 4px; }
      .nav { flex-direction: column; gap: 12px; align-items: flex-start; }
      .recurring-card, .upcoming-card { flex-direction: column; align-items: flex-start; gap: 8px; }
      .recurring-time, .upcoming-date { min-width: auto; }
      .container { padding: 24px 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a href="index.html" class="logo">ü¶û</a>
        <h1>Mission <span>Control</span></h1>
      </div>
      <div class="nav-links">
        <a href="index.html" class="nav-link">Tasks</a>
        <a href="calendar.html" class="nav-link active">Calendar</a>
      </div>
    </nav>

    <div class="month-header">
      <div class="month-title" id="monthTitle"></div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <button class="month-btn" onclick="changeMonth(0)" title="Today">‚Ä¢</button>
        <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
    </div>

    <div class="cal-grid" id="calGrid"></div>

    <div class="section-title">üîÅ Daily Schedule (Recurring)</div>
    <div class="recurring-list" id="recurringList"></div>

    <div class="section-title">üìå Upcoming One-Time Events</div>
    <div class="upcoming-list" id="upcomingList"></div>

    <div class="updated-label" id="updatedLabel"></div>
  </div>

  <!-- Detail modal -->
  <div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div class="modal-meta" id="modalMeta"></div>
    </div>
  </div>

  <script>
    let data = { recurring: [], scheduled: [] };
    let viewYear, viewMonth;

    const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    async function load() {
      try {
        const res = await fetch('calendar.json?t=' + Date.now());
        data = await res.json();
        render();
        document.getElementById('updatedLabel').textContent =
          'Last updated: ' + new Date(data.lastUpdated).toLocaleString();
      } catch(e) {
        console.error(e);
      }
    }

    function init() {
      const now = new Date();
      viewYear = now.getFullYear();
      viewMonth = now.getMonth();
      load();
    }

    function changeMonth(delta) {
      if (delta === 0) {
        const now = new Date();
        viewYear = now.getFullYear();
        viewMonth = now.getMonth();
      } else {
        viewMonth += delta;
        if (viewMonth < 0) { viewMonth = 11; viewYear--; }
        if (viewMonth > 11) { viewMonth = 0; viewYear++; }
      }
      render();
    }

    function render() {
      document.getElementById('monthTitle').textContent = MONTHS[viewMonth] + ' ' + viewYear;
      renderCalendar();
      renderRecurring();
      renderUpcoming();
    }

    function getEventsForDate(y, m, d) {
      const events = [];
      const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

      // Recurring ‚Äî show on every day of the month
      data.recurring.forEach(r => {
        if (r.enabled) {
          events.push({ ...r, type: 'recurring' });
        }
      });

      // One-shot ‚Äî match date
      data.scheduled.forEach(s => {
        const sd = s.datetime.slice(0, 10);
        if (sd === dateStr) {
          events.push({ ...s, type: 'one-shot' });
        }
      });

      return events;
    }

    function renderCalendar() {
      const grid = document.getElementById('calGrid');
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

      // Day-of-week headers
      let html = DAYS.map(d => `<div class="cal-dow">${d}</div>`).join('');

      // First day of month
      const firstDay = new Date(viewYear, viewMonth, 1).getDay();
      const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
      const daysInPrev = new Date(viewYear, viewMonth, 0).getDate();

      // Previous month fill
      for (let i = firstDay - 1; i >= 0; i--) {
        const d = daysInPrev - i;
        html += `<div class="cal-day other-month"><div class="cal-day-num">${d}</div></div>`;
      }

      // Current month
      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = dateStr === todayStr;
        const events = getEventsForDate(viewYear, viewMonth, d);

        // Only show one-shot events on the calendar cells (recurring shown separately below)
        const oneShots = events.filter(e => e.type === 'one-shot');
        const MAX_SHOW = 3;

        let eventsHtml = '';
        oneShots.slice(0, MAX_SHOW).forEach(e => {
          eventsHtml += `<div class="cal-event one-shot assignee-${e.assignee}" onclick="showDetail('${esc(e.id)}')" title="${esc(e.title)}">${esc(e.title)}</div>`;
        });
        if (oneShots.length > MAX_SHOW) {
          eventsHtml += `<div class="cal-more">+${oneShots.length - MAX_SHOW} more</div>`;
        }

        // Show recurring indicator dot
        const hasRecurring = events.some(e => e.type === 'recurring');
        const recurringDot = hasRecurring ? `<div style="width:4px;height:4px;border-radius:50%;background:var(--violet);display:inline-block;margin-left:6px;vertical-align:middle;box-shadow:0 0 6px rgba(139,92,246,0.5)"></div>` : '';

        html += `<div class="cal-day${isToday ? ' today' : ''}">
          <div class="cal-day-num">${d}${recurringDot}</div>
          ${eventsHtml}
        </div>`;
      }

      // Next month fill
      const totalCells = firstDay + daysInMonth;
      const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let d = 1; d <= remaining; d++) {
        html += `<div class="cal-day other-month"><div class="cal-day-num">${d}</div></div>`;
      }

      grid.innerHTML = html;
    }

    function renderRecurring() {
      const list = document.getElementById('recurringList');
      const sorted = [...data.recurring].sort((a, b) => {
        const timeA = a.schedule.match(/(\d+):(\d+)\s*(AM|PM)/i);
        const timeB = b.schedule.match(/(\d+):(\d+)\s*(AM|PM)/i);
        if (!timeA || !timeB) return 0;
        const ha = (parseInt(timeA[1]) % 12) + (timeA[3].toUpperCase() === 'PM' ? 12 : 0);
        const hb = (parseInt(timeB[1]) % 12) + (timeB[3].toUpperCase() === 'PM' ? 12 : 0);
        return ha - hb || parseInt(timeA[2]) - parseInt(timeB[2]);
      });

      list.innerHTML = sorted.map(r => `
        <div class="recurring-card" onclick="showDetail('${esc(r.id)}')">
          <div class="recurring-time">${esc(r.schedule.replace('Daily at ', ''))}</div>
          <div class="recurring-info">
            <div class="recurring-title">${esc(r.title)}</div>
            <div class="recurring-desc">${esc(r.description)}</div>
          </div>
          <span class="assignee-pill assignee-${r.assignee}">${r.assignee}</span>
          <span class="recurring-status ${r.enabled ? 'enabled' : 'disabled'}">${r.enabled ? 'Active' : 'Off'}</span>
        </div>
      `).join('');
    }

    function renderUpcoming() {
      const list = document.getElementById('upcomingList');
      const now = new Date();
      const upcoming = data.scheduled
        .filter(s => new Date(s.datetime) >= now)
        .sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

      if (upcoming.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:13px">No upcoming events.</div>';
        return;
      }

      list.innerHTML = upcoming.map(s => {
        const d = new Date(s.datetime);
        const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const timeStr = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        return `
          <div class="upcoming-card" onclick="showDetail('${esc(s.id)}')">
            <div class="upcoming-date">${dateStr} ¬∑ ${timeStr}</div>
            <div class="upcoming-info">
              <div class="upcoming-title">${esc(s.title)}</div>
              <div class="upcoming-desc">${esc(s.description)}</div>
            </div>
            <span class="assignee-pill assignee-${s.assignee}">${s.assignee}</span>
          </div>
        `;
      }).join('');
    }

    function showDetail(id) {
      const item = [...data.recurring, ...data.scheduled].find(x => x.id === id);
      if (!item) return;
      document.getElementById('modalTitle').textContent = item.title;
      document.getElementById('modalDesc').textContent = item.description;

      let meta = `<strong>Assignee:</strong> ${item.assignee}<br>`;
      meta += `<strong>Category:</strong> ${item.category}<br>`;
      if (item.schedule) meta += `<strong>Schedule:</strong> ${item.schedule}<br>`;
      if (item.cron) meta += `<strong>Cron:</strong> ${item.cron}<br>`;
      if (item.datetime) {
        const d = new Date(item.datetime);
        meta += `<strong>Date:</strong> ${d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} at ${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}<br>`;
      }
      if (item.enabled !== undefined) meta += `<strong>Status:</strong> ${item.enabled ? '‚úÖ Active' : '‚è∏ Disabled'}<br>`;
      if (item.oneShot) meta += `<strong>Type:</strong> One-time<br>`;
      if (item.cronJobId) meta += `<strong>Cron Job ID:</strong> <code style="font-size:11px;color:var(--text-muted)">${item.cronJobId}</code>`;

      document.getElementById('modalMeta').innerHTML = meta;
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('show');
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    init();
    setInterval(load, 60000);
  </script>
</body>
</html>
