<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar ‚Äî Mission Control</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a href="index.html" class="nav-logo">ü¶û</a>
        <div class="nav-title">Mission Control</div>
      </div>
      <div class="nav-tabs">
        <a href="index.html" class="nav-tab">Tasks</a>
        <a href="calendar.html" class="nav-tab active">Calendar</a>
        <a href="memory.html" class="nav-tab">Memory</a>
      </div>
      <div class="nav-right">
        <div class="nav-status"><div class="nav-status-dot"></div>Online</div>
      </div>
    </nav>

    <div class="month-header">
      <div class="month-title" id="monthTitle"></div>
      <div class="month-nav">
        <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
        <button class="month-btn" onclick="changeMonth(0)" title="Today">‚Ä¢</button>
        <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
      </div>
    </div>
    <div class="cal-grid" id="calGrid"></div>

    <div class="section-label">üîÅ Daily Schedule</div>
    <div class="schedule-list" id="recurringList"></div>

    <div class="section-label">üìå Upcoming</div>
    <div class="schedule-list" id="upcomingList"></div>

    <div class="updated-label" id="updatedLabel"></div>
  </div>

  <div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div class="modal-meta" id="modalMeta"></div>
    </div>
  </div>

  <script>
    let data = { recurring: [], scheduled: [] };
    let viewYear, viewMonth;
    const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    async function load() {
      try {
        const res = await fetch('calendar.json?t=' + Date.now());
        data = await res.json();
        render();
        document.getElementById('updatedLabel').textContent = 'Updated ' + new Date(data.lastUpdated).toLocaleString();
      } catch(e) { console.error(e); }
    }

    function init() {
      const now = new Date();
      viewYear = now.getFullYear();
      viewMonth = now.getMonth();
      load();
    }

    function changeMonth(d) {
      if (d === 0) { const n = new Date(); viewYear = n.getFullYear(); viewMonth = n.getMonth(); }
      else { viewMonth += d; if (viewMonth < 0) { viewMonth = 11; viewYear--; } if (viewMonth > 11) { viewMonth = 0; viewYear++; } }
      render();
    }

    function render() {
      document.getElementById('monthTitle').textContent = MONTHS[viewMonth] + ' ' + viewYear;
      renderCal();
      renderRecurring();
      renderUpcoming();
    }

    function renderCal() {
      const grid = document.getElementById('calGrid');
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      let html = DAYS.map(d => `<div class="cal-dow">${d}</div>`).join('');
      const firstDay = new Date(viewYear, viewMonth, 1).getDay();
      const dim = new Date(viewYear, viewMonth + 1, 0).getDate();
      const prevDim = new Date(viewYear, viewMonth, 0).getDate();

      for (let i = firstDay - 1; i >= 0; i--) html += `<div class="cal-day other-month"><div class="cal-day-num">${prevDim-i}</div></div>`;

      for (let d = 1; d <= dim; d++) {
        const ds = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = ds === todayStr;
        const events = data.scheduled.filter(s => s.datetime.slice(0,10) === ds);
        let ev = events.slice(0,3).map(e =>
          `<div class="cal-event one-shot" onclick="event.stopPropagation();showDetail('${e.id}')" title="${esc(e.title)}">${esc(e.title)}</div>`
        ).join('');
        if (events.length > 3) ev += `<div style="font-size:9px;color:var(--text-dim);padding:1px 5px">+${events.length-3}</div>`;
        html += `<div class="cal-day${isToday?' today':''}"><div class="cal-day-num">${d}</div>${ev}</div>`;
      }

      const total = firstDay + dim;
      const rem = total % 7 === 0 ? 0 : 7 - (total % 7);
      for (let d = 1; d <= rem; d++) html += `<div class="cal-day other-month"><div class="cal-day-num">${d}</div></div>`;
      grid.innerHTML = html;
    }

    function renderRecurring() {
      const list = document.getElementById('recurringList');
      const sorted = [...data.recurring].sort((a,b) => {
        const ta = a.schedule.match(/(\d+):(\d+)\s*(AM|PM)/i);
        const tb = b.schedule.match(/(\d+):(\d+)\s*(AM|PM)/i);
        if (!ta||!tb) return 0;
        const ha = (parseInt(ta[1])%12)+(ta[3].toUpperCase()==='PM'?12:0);
        const hb = (parseInt(tb[1])%12)+(tb[3].toUpperCase()==='PM'?12:0);
        return ha-hb;
      });
      list.innerHTML = sorted.map(r => `
        <div class="schedule-row" onclick="showDetail('${r.id}')">
          <div class="schedule-time">${esc(r.schedule.replace('Daily at ',''))}</div>
          <div class="schedule-info">
            <div class="schedule-title">${esc(r.title)}</div>
            <div class="schedule-desc">${esc(r.description)}</div>
          </div>
          <span class="pill pill-${r.assignee}">${r.assignee}</span>
          <span class="pill" style="background:${r.enabled?'var(--green-dim)':'var(--surface-3)'};color:${r.enabled?'var(--green)':'var(--text-dim)'}">${r.enabled?'Active':'Off'}</span>
        </div>
      `).join('');
    }

    function renderUpcoming() {
      const list = document.getElementById('upcomingList');
      const now = new Date();
      const upcoming = data.scheduled.filter(s => new Date(s.datetime) >= now).sort((a,b) => new Date(a.datetime) - new Date(b.datetime));
      if (!upcoming.length) { list.innerHTML = '<div class="empty-state">No upcoming events.</div>'; return; }
      list.innerHTML = upcoming.map(s => {
        const d = new Date(s.datetime);
        const ds = d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
        const ts = d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
        return `
          <div class="schedule-row" onclick="showDetail('${s.id}')">
            <div class="upcoming-date">${ds} ¬∑ ${ts}</div>
            <div class="schedule-info">
              <div class="schedule-title">${esc(s.title)}</div>
              <div class="schedule-desc">${esc(s.description)}</div>
            </div>
            <span class="pill pill-${s.assignee}">${s.assignee}</span>
          </div>`;
      }).join('');
    }

    function showDetail(id) {
      const item = [...data.recurring, ...data.scheduled].find(x => x.id === id);
      if (!item) return;
      document.getElementById('modalTitle').textContent = item.title;
      document.getElementById('modalDesc').textContent = item.description;
      let meta = `<strong>Assignee:</strong> ${item.assignee}<br>`;
      meta += `<strong>Category:</strong> ${item.category}<br>`;
      if (item.schedule) meta += `<strong>Schedule:</strong> ${item.schedule}<br>`;
      if (item.cron) meta += `<strong>Cron:</strong> ${item.cron}<br>`;
      if (item.datetime) { const d = new Date(item.datetime); meta += `<strong>Date:</strong> ${d.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} at ${d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}<br>`; }
      if (item.enabled !== undefined) meta += `<strong>Status:</strong> ${item.enabled?'Active':'Disabled'}<br>`;
      if (item.cronJobId) meta += `<strong>Job ID:</strong> <code style="font-size:10px;color:var(--text-dim)">${item.cronJobId}</code>`;
      document.getElementById('modalMeta').innerHTML = meta;
      document.getElementById('modal').classList.add('show');
    }

    function closeModal() { document.getElementById('modal').classList.remove('show'); }
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    init();
    setInterval(load, 60000);
  </script>
</body>
</html>
