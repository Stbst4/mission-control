<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory â€” Mission Control</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a href="index.html" class="nav-logo">ðŸ¦ž</a>
        <div class="nav-title">Mission Control</div>
      </div>
      <div class="nav-tabs">
        <a href="index.html" class="nav-tab">Tasks</a>
        <a href="calendar.html" class="nav-tab">Calendar</a>
        <a href="memory.html" class="nav-tab active">Memory</a>
      </div>
      <div class="nav-right">
        <div class="nav-status"><div class="nav-status-dot"></div>Online</div>
      </div>
    </nav>

    <div class="stats" id="stats"></div>

    <div class="search-wrap">
      <div class="search-icon">âŒ•</div>
      <input type="text" class="search-input" id="searchInput" placeholder="Search memories..." autocomplete="off" />
      <div class="search-meta" id="searchMeta"></div>
    </div>
    <div class="search-shortcut" id="searchHint">Press <kbd style="background:var(--surface-3);padding:1px 5px;border-radius:3px;font-size:10px;border:1px solid var(--border)">/</kbd> to search Â· keyword, date, person, topic</div>

    <div class="filters" id="filters"></div>
    <div class="memory-grid" id="memoryGrid"></div>
    <div class="updated-label" id="updatedLabel"></div>
  </div>

  <div class="viewer-overlay" id="viewer" onclick="if(event.target===this)closeViewer()">
    <div class="viewer">
      <div class="viewer-header">
        <div class="viewer-title-wrap">
          <span id="viewerIcon"></span>
          <span class="viewer-title" id="viewerTitle"></span>
        </div>
        <button class="viewer-close" onclick="closeViewer()">Ã—</button>
      </div>
      <div class="viewer-meta" id="viewerMeta"></div>
      <div class="viewer-body" id="viewerBody"></div>
    </div>
  </div>

  <script>
    let allMemories = [];
    let activeFilter = 'all';
    let searchQuery = '';
    let debounceTimer;

    async function load() {
      try {
        const res = await fetch('memory-index.json?t=' + Date.now());
        const data = await res.json();
        allMemories = data.memories;
        renderStats(data);
        renderFilters();
        renderGrid();
        document.getElementById('updatedLabel').textContent = 'Synced ' + new Date(data.lastUpdated).toLocaleString();
      } catch(e) { console.error(e); }
    }

    function renderStats(data) {
      const cats = {};
      allMemories.forEach(m => { cats[m.category] = (cats[m.category]||0)+1; });
      const kb = (data.totalSize/1024).toFixed(0);
      document.getElementById('stats').innerHTML = `
        <div class="stat-card"><div class="stat-label">Files</div><div class="stat-value">${data.totalFiles}</div></div>
        <div class="stat-card"><div class="stat-label">Size</div><div class="stat-value">${kb}<span style="font-size:12px;color:var(--text-muted)"> KB</span></div></div>
        <div class="stat-card"><div class="stat-label">Daily</div><div class="stat-value" style="color:var(--blue)">${cats.daily||0}</div></div>
        <div class="stat-card"><div class="stat-label">Journal</div><div class="stat-value" style="color:var(--green)">${cats.journal||0}</div></div>
        <div class="stat-card"><div class="stat-label">Reference</div><div class="stat-value" style="color:var(--violet)">${cats.reference||0}</div></div>
        <div class="stat-card"><div class="stat-label">Business</div><div class="stat-value" style="color:var(--yellow)">${cats.business||0}</div></div>
      `;
    }

    function renderFilters() {
      const cats = { all: allMemories.length };
      allMemories.forEach(m => { cats[m.category]=(cats[m.category]||0)+1; });
      const labels = {all:'All',core:'Core',daily:'Daily',journal:'Journal',business:'Business',reference:'Reference',system:'System'};
      const order = ['all','core','daily','journal','business','reference','system'];
      document.getElementById('filters').innerHTML = order.filter(k=>cats[k]).map(k =>
        `<button class="filter-btn ${k===activeFilter?'active':''}" onclick="setFilter('${k}')">${labels[k]} <span style="opacity:0.5">${cats[k]}</span></button>`
      ).join('');
    }

    function setFilter(f) { activeFilter = f; renderFilters(); renderGrid(); }

    function searchMemories(query) {
      if (!query) return allMemories.map(m => ({...m, matches:0, snippets:[]}));
      const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
      return allMemories.map(m => {
        const text = (m.title+' '+m.content+' '+(m.filename||'')).toLowerCase();
        let matches = 0;
        const snippets = [];
        terms.forEach(t => {
          let idx = -1;
          while ((idx = text.indexOf(t, idx+1)) !== -1) {
            matches++;
            if (snippets.length < 2) {
              const raw = m.content||m.title;
              const offset = idx - (m.title.length+1);
              const start = Math.max(0, offset - 50);
              const end = Math.min(raw.length, offset + t.length + 50);
              if (start < raw.length && end > 0) snippets.push(raw.substring(Math.max(0,start), Math.min(raw.length,end)));
            }
          }
        });
        return {...m, matches, snippets};
      }).filter(m => m.matches > 0).sort((a,b) => b.matches - a.matches);
    }

    function highlightText(text, query) {
      if (!query) return esc(text);
      const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
      let result = esc(text);
      terms.forEach(t => { result = result.replace(new RegExp(`(${escRx(t)})`, 'gi'), '<mark>$1</mark>'); });
      return result;
    }
    function escRx(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    function renderGrid() {
      let memories = searchQuery ? searchMemories(searchQuery) : allMemories.map(m => ({...m, matches:0}));
      if (activeFilter !== 'all') memories = memories.filter(m => m.category === activeFilter);

      if (!searchQuery) {
        memories.sort((a,b) => {
          if (a.category==='core' && b.category!=='core') return -1;
          if (b.category==='core' && a.category!=='core') return 1;
          if (a.date && b.date) return b.date.localeCompare(a.date);
          if (a.date) return -1;
          if (b.date) return 1;
          return a.title.localeCompare(b.title);
        });
      }

      const meta = document.getElementById('searchMeta');
      if (searchQuery) { meta.textContent = `${memories.length} result${memories.length!==1?'s':''}`; document.getElementById('searchHint').style.display='none'; }
      else { meta.textContent = ''; document.getElementById('searchHint').style.display=''; }

      if (!memories.length) {
        document.getElementById('memoryGrid').innerHTML = `<div class="empty-state" style="grid-column:1/-1">No results for "${esc(searchQuery)}"</div>`;
        return;
      }

      document.getElementById('memoryGrid').innerHTML = memories.map(m => {
        const preview = getPreview(m);
        const sz = m.size > 1024 ? (m.size/1024).toFixed(1)+' KB' : m.size+' B';
        return `
          <div class="memory-card" onclick='openViewer(${JSON.stringify(m.id)})'>
            <div class="memory-header">
              <span class="memory-icon">${m.icon}</span>
              <span class="memory-title">${highlightText(m.title, searchQuery)}</span>
              <span class="memory-cat pill pill-${m.category==='core'?'blocked':m.category==='daily'?'in-progress':m.category==='journal'?'done':m.category==='business'?'shane':m.category==='reference'?'automation':'admin'}">${m.category}</span>
            </div>
            <div class="memory-preview">${highlightText(preview, searchQuery)}</div>
            <div class="memory-footer">
              <span>${m.date || m.filename}</span>
              ${m.matches ? `<span class="match-count">${m.matches} match${m.matches!==1?'es':''}</span>` : ''}
              <span>${sz} Â· ${m.lines} lines</span>
            </div>
          </div>`;
      }).join('');
    }

    function getPreview(m) {
      if (m.snippets && m.snippets.length) return 'â€¦' + m.snippets[0].replace(/\n/g,' ').trim() + 'â€¦';
      const lines = (m.content||'').split('\n').filter(l => l.trim() && !l.startsWith('#'));
      return lines.slice(0,4).join(' ').substring(0,200);
    }

    function renderMarkdown(md) {
      let html = esc(md);
      html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
      html = html.replace(/^---$/gm, '<hr>');
      html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
      html = html.replace(/\n\n/g, '</p><p>');
      html = '<p>' + html + '</p>';
      html = html.replace(/<p>\s*<\/p>/g, '');
      html = html.replace(/<p>\s*(<h[123]>)/g, '$1');
      html = html.replace(/(<\/h[123]>)\s*<\/p>/g, '$1');
      html = html.replace(/<p>\s*(<ul>)/g, '$1');
      html = html.replace(/(<\/ul>)\s*<\/p>/g, '$1');
      html = html.replace(/<p>\s*(<pre>)/g, '$1');
      html = html.replace(/(<\/pre>)\s*<\/p>/g, '$1');
      html = html.replace(/<p>\s*(<hr>)/g, '$1');
      if (searchQuery) {
        searchQuery.toLowerCase().split(/\s+/).filter(Boolean).forEach(t => {
          html = html.replace(new RegExp(`(${escRx(t)})`, 'gi'), '<mark>$1</mark>');
        });
      }
      return html;
    }

    function openViewer(id) {
      const m = allMemories.find(x => x.id === id);
      if (!m) return;
      document.getElementById('viewerIcon').textContent = m.icon;
      document.getElementById('viewerTitle').textContent = m.title;
      const sz = m.size > 1024 ? (m.size/1024).toFixed(1)+' KB' : m.size+' B';
      document.getElementById('viewerMeta').innerHTML = `
        <span><strong>File:</strong> ${m.filename}</span>
        <span><strong>Category:</strong> ${m.category}</span>
        ${m.date ? `<span><strong>Date:</strong> ${m.date}</span>` : ''}
        <span><strong>Size:</strong> ${sz} Â· ${m.lines} lines</span>
      `;
      document.getElementById('viewerBody').innerHTML = renderMarkdown(m.content);
      document.getElementById('viewer').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeViewer() {
      document.getElementById('viewer').classList.remove('show');
      document.body.style.overflow = '';
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }

    document.getElementById('searchInput').addEventListener('input', e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => { searchQuery = e.target.value.trim(); renderGrid(); }, 150);
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeViewer();
      if (e.key === '/' && !e.ctrlKey && !e.metaKey && document.activeElement !== document.getElementById('searchInput')) {
        e.preventDefault();
        document.getElementById('searchInput').focus();
      }
    });

    load();
  </script>
</body>
</html>
